<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Signal History & Track Record</title>
<style>
:root{--bg:#f4f1eb;--primary:#5b8fa8;--dark:#34495e;--green:#27ae60;--red:#e74c3c;--gold:#f39c12;--purple:#8e44ad;--blue:#2980b9;--orange:#d35400}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);font-family:'Segoe UI',Tahoma,sans-serif;color:#333;min-height:100vh}
.header{background:linear-gradient(135deg,var(--dark),#4a6d8c,var(--primary),#6fa3bd);padding:20px 30px;color:#fff;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.header h1{font-size:1.4rem;text-shadow:0 2px 4px rgba(0,0,0,0.2)}
.header p{font-size:0.8rem;opacity:0.85;margin-top:2px}
.h-btns{display:flex;gap:8px;flex-wrap:wrap}
.h-btns a,.h-btns button{padding:10px 20px;border-radius:8px;font-size:0.85rem;font-weight:600;cursor:pointer;text-decoration:none;border:none;color:#fff;display:inline-flex;align-items:center;gap:6px;transition:transform 0.2s}
.h-btns a:hover,.h-btns button:hover{transform:translateY(-1px)}
.btn-back{background:rgba(255,255,255,0.2);backdrop-filter:blur(6px)}
.btn-export{background:var(--green)}
.btn-clear{background:var(--red)}
.btn-rescan{background:linear-gradient(135deg,#8e44ad,#9b59b6)}
.filter-bar{background:rgba(255,255,255,0.7);backdrop-filter:blur(10px);padding:14px 30px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;border-bottom:1px solid rgba(0,0,0,0.08)}
.filter-bar select,.filter-bar input{padding:7px 12px;border-radius:6px;border:1px solid #d0d0d0;font-size:0.8rem;background:#fff}
.filter-bar button{padding:7px 14px;border-radius:6px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-size:0.8rem}
.container{max-width:1500px;margin:0 auto;padding:20px 30px}
.stats-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:12px;margin-bottom:20px}
.stat-card{background:rgba(255,255,255,0.8);backdrop-filter:blur(10px);border-radius:10px;padding:14px;text-align:center;border-top:3px solid var(--primary)}
.stat-card h4{font-size:0.7rem;color:#888;text-transform:uppercase;margin-bottom:4px}
.stat-card .val{font-size:1.3rem;font-weight:700}
.sc-green{border-top-color:var(--green)}.sc-red{border-top-color:var(--red)}.sc-blue{border-top-color:var(--blue)}.sc-gold{border-top-color:var(--gold)}.sc-purple{border-top-color:var(--purple)}.sc-orange{border-top-color:var(--orange)}
.grade-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.grade-card{background:rgba(255,255,255,0.8);backdrop-filter:blur(10px);border-radius:10px;padding:16px;border-top:3px solid var(--primary)}
.grade-card h3{font-size:1rem;margin-bottom:10px;color:var(--dark)}
.grade-card .gd-row{display:flex;justify-content:space-between;padding:4px 0;font-size:0.8rem;border-bottom:1px solid rgba(0,0,0,0.05)}
.grade-card .gd-row:last-child{border-bottom:none}
.signal-log{background:rgba(255,255,255,0.8);backdrop-filter:blur(10px);border-radius:12px;padding:20px;margin-bottom:20px}
.signal-log h3{font-size:1rem;margin-bottom:12px;color:var(--dark)}
.signal-log h3 span{background:var(--primary);color:#fff;padding:2px 10px;border-radius:10px;font-size:0.75rem;margin-left:8px}
table{width:100%;border-collapse:collapse;font-size:0.75rem}
thead{background:var(--dark);color:#fff}
th{padding:8px 6px;cursor:pointer;white-space:nowrap;font-size:0.7rem;text-align:left}
th:hover{background:#4a6d8c}
td{padding:7px 6px;border-bottom:1px solid rgba(0,0,0,0.06);vertical-align:top}
tr:hover{background:rgba(91,143,168,0.06)}
.pagination{display:flex;justify-content:center;gap:4px;margin-top:14px}
.pagination button{padding:6px 12px;border:1px solid #d0d0d0;border-radius:6px;background:#fff;cursor:pointer;font-size:0.8rem}
.pagination button:disabled{opacity:0.4;cursor:default}
.footer{text-align:center;padding:20px;color:#999;font-size:0.75rem}
.track-col{min-width:85px;text-align:center}
.track-status{display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.65rem;font-weight:600}
.ts-open{background:rgba(41,128,185,0.15);color:#2980b9}
.ts-pending{background:rgba(243,156,18,0.15);color:#f39c12}
.ts-target{background:rgba(39,174,96,0.15);color:#27ae60}
.ts-stop{background:rgba(231,76,60,0.15);color:#e74c3c}
.ts-expired{background:rgba(127,140,141,0.15);color:#7f8c8d}
.ts-error{background:rgba(231,76,60,0.1);color:#e74c3c}
.pnl-live{font-weight:600;font-size:0.72rem}
.pnl-live.favor{color:#27ae60}
.pnl-live.against{color:#e74c3c}
.pnl-live.neutral{color:#7f8c8d}
.track-details{font-size:0.65rem;color:#999;margin-top:2px}
.rescan-status{position:fixed;top:20px;right:20px;background:rgba(255,255,255,0.96);backdrop-filter:blur(14px);border-radius:12px;padding:18px 24px;box-shadow:0 8px 32px rgba(0,0,0,0.18);z-index:10000;min-width:300px;border-left:4px solid #8e44ad;display:none}
.rescan-status.active{display:block}
.rescan-status h4{margin:0 0 8px;color:#8e44ad;font-size:0.95rem}
.rs-prog{background:#eee;border-radius:6px;height:8px;margin:8px 0;overflow:hidden}
.rs-bar{height:100%;background:linear-gradient(90deg,#8e44ad,#9b59b6);border-radius:6px;transition:width 0.3s}
.rs-text{font-size:0.8rem;color:#666}
.rs-result{margin-top:10px;font-size:0.8rem;line-height:1.6}
.rs-result .triggered{color:#27ae60}
.rs-result .expired{color:#e74c3c}
.rs-result .still-pending{color:#f39c12}
.rs-result .open-trade{color:#2980b9}
.mdot{display:inline-block;width:8px;height:8px;border-radius:50%;margin:0 1px}
@media(max-width:1000px){.stats-grid{grid-template-columns:repeat(4,1fr)}.grade-grid{grid-template-columns:1fr}}
@media(max-width:600px){.stats-grid{grid-template-columns:repeat(2,1fr)}.header{flex-direction:column;text-align:center}.filter-bar{flex-direction:column}}
</style>
</head>
<body>

<div class="rescan-status" id="rescanStatus">
  <h4>üîÑ Rescanning Trades...</h4>
  <div class="rs-prog"><div class="rs-bar" id="rsBar" style="width:0%"></div></div>
  <div class="rs-text" id="rsText">Preparing...</div>
  <div class="rs-result" id="rsResult"></div>
</div>

<div class="header">
  <div>
    <h1>üìã Signal History & Track Record</h1>
    <p>Auto-logged signals from every scan</p>
  </div>
  <div class="h-btns">
    <a href="index.html" class="btn-back">‚Üê Back to Scanner</a>
    <button class="btn-rescan" id="rescanBtn" onclick="rescanTrades()">üîÑ Rescan Trades</button>
    <button class="btn-export" onclick="exportCSV()">üì• Export CSV</button>
    <button class="btn-clear" onclick="clearAll()">üóëÔ∏è Clear All</button>
  </div>
</div>

<div class="filter-bar">
  <select id="fGrade" onchange="applyFilters()">
    <option value="">All Grades</option>
    <option value="A+">A+</option>
    <option value="A">A</option>
    <option value="B+">B+</option>
  </select>
  <select id="fDir" onchange="applyFilters()">
    <option value="">All Directions</option>
    <option value="long">Buy / Long</option>
    <option value="short">Sell / Short</option>
  </select>
  <select id="fTrend" onchange="applyFilters()">
    <option value="">All Trends</option>
    <option value="uptrend">Uptrend</option>
    <option value="downtrend">Downtrend</option>
    <option value="sideways">Sideways</option>
  </select>
  <select id="fOutcome" onchange="applyFilters()">
    <option value="">All Outcomes</option>
    <option value="pending">‚è≥ Pending</option>
    <option value="open">üîµ Open (Triggered)</option>
    <option value="target_hit">‚úÖ Target Hit</option>
    <option value="stop_hit">‚ùå Stop Hit</option>
    <option value="expired">‚è∞ Expired</option>
  </select>
  <input type="text" id="fSymbol" placeholder="Search symbol..." oninput="applyFilters()">
  <button onclick="resetFilters()">Reset</button>
</div>

<div class="container">
  <div class="stats-grid" id="statsGrid"></div>
  <div class="grade-grid" id="gradeGrid"></div>
  <div class="signal-log">
    <h3>Signal Log <span>0</span></h3>
    <div id="signalLog"></div>
  </div>
</div>

<div class="footer">
  Peak & Trough Scanner v3.0 ‚Äî Signal history stored in browser localStorage (max 5000)
</div>

<script>
const PER_PAGE=50;
let allSignals=[];
let filtered=[];
let currentPage=1;
let sortCol='scan_date';
let sortDir='desc';

// Load signals
try{
  let raw=localStorage.getItem('signalHistory');
  if(raw) allSignals=JSON.parse(raw);
}catch(e){console.error('Failed to load signals:',e)}

function save(){
  localStorage.setItem('signalHistory',JSON.stringify(allSignals));
  applyFilters();
}

function getActiveCount(s){
  let c=0;
  if(s.exhaustion_components){
    let ec=s.exhaustion_components;
    if(ec.zscore>=5)c++;
    if(ec.wick>=5)c++;
    if(ec.volume>=5)c++;
    if(ec.momentum>=5)c++;
  }
  if(s.mtf_confirmed)c++;
  return c;
}

function modelDots(s){
  let h='';
  if(s.exhaustion_components){
    let ec=s.exhaustion_components;
    let colors=[
      {v:ec.zscore||0,t:5,c:'#2980b9'},
      {v:ec.wick||0,t:5,c:'#8e44ad'},
      {v:ec.volume||0,t:5,c:'#d35400'},
      {v:ec.momentum||0,t:5,c:'#27ae60'}
    ];
    colors.forEach(m=>{
      let on=m.v>=m.t;
      h+=`<span class="mdot" style="background:${on?m.c:'#ccc'}" title="${m.v}"></span>`;
    });
    let mtfOn=s.mtf_confirmed||false;
    h+=`<span class="mdot" style="background:${mtfOn?'#f39c12':'#ccc'}" title="MTF"></span>`;
  } else if(s.agreeing_models){
    let models=['MRB','MDD','VRC','OFI','MTC'];
    let active=s.agreeing_models?s.agreeing_models.split(',').map(x=>x.trim()):[];
    let colors=['#2980b9','#8e44ad','#d35400','#27ae60','#f39c12'];
    models.forEach((m,i)=>{
      let on=active.includes(m);
      h+=`<span class="mdot" style="background:${on?colors[i]:'#ccc'}" title="${m}"></span>`;
    });
  } else {
    for(let i=0;i<5;i++) h+=`<span class="mdot" style="background:#ccc"></span>`;
  }
  return h;
}

function calcPnL(s){
  let ep=parseFloat(s.exit_price);
  let ent=parseFloat(s.entry);
  if(isNaN(ep)||isNaN(ent)||ent===0||ep===0) return null;
  let dir=(s.direction||'').toUpperCase();
  if(dir.includes('LONG')||dir.includes('BUY')){
    return Math.round((ep-ent)/ent*10000)/100;
  } else {
    return Math.round((ent-ep)/ent*10000)/100;
  }
}

function updateOutcome(id,val){
  let idx=allSignals.findIndex(s=>s._id===id);
  if(idx>-1){allSignals[idx].outcome=val;save();}
}

function updateExit(id,val){
  let idx=allSignals.findIndex(s=>s._id===id);
  if(idx>-1){
    allSignals[idx].exit_price=val;
    allSignals[idx].pnl=calcPnL(allSignals[idx]);
    save();
  }
}

function applyFilters(){
  let fG=document.getElementById('fGrade').value;
  let fD=document.getElementById('fDir').value;
  let fT=document.getElementById('fTrend').value;
  let fO=document.getElementById('fOutcome').value;
  let fS=document.getElementById('fSymbol').value.toLowerCase();

  filtered=allSignals.filter(s=>{
    if(fG && (s.grade||s.signal_grade||'')!==fG) return false;
    if(fD){
      let dir=(s.direction||'').toLowerCase();
      if(fD==='long' && !dir.includes('long') && !dir.includes('buy')) return false;
      if(fD==='short' && !dir.includes('short') && !dir.includes('sell')) return false;
    }
    if(fT && (s.trend||'').toLowerCase()!==fT) return false;
    if(fO){
      if(fO==='open'){
        if(s.track_status!=='open') return false;
      } else {
        if((s.outcome||'pending')!==fO) return false;
      }
    }
    if(fS && !(s.symbol||'').toLowerCase().includes(fS)) return false;
    return true;
  });

  // Sort
  filtered.sort((a,b)=>{
    let av=a[sortCol]||'';
    let bv=b[sortCol]||'';
    if(typeof av==='number'&&typeof bv==='number'){
      return sortDir==='asc'?av-bv:bv-av;
    }
    let cmp=String(av).localeCompare(String(bv));
    return sortDir==='asc'?cmp:-cmp;
  });

  currentPage=1;
  render();
}

function resetFilters(){
  document.getElementById('fGrade').value='';
  document.getElementById('fDir').value='';
  document.getElementById('fTrend').value='';
  document.getElementById('fOutcome').value='';
  document.getElementById('fSymbol').value='';
  filtered=[...allSignals];
  currentPage=1;
  render();
}

function sortBy(col){
  if(sortCol===col){sortDir=sortDir==='asc'?'desc':'asc';}
  else{sortCol=col;sortDir='desc';}
  filtered.sort((a,b)=>{
    let av=a[sortCol]||'';
    let bv=b[sortCol]||'';
    if(typeof av==='number'&&typeof bv==='number'){
      return sortDir==='asc'?av-bv:bv-av;
    }
    let cmp=String(av).localeCompare(String(bv));
    return sortDir==='asc'?cmp:-cmp;
  });
  renderTable();
}

function renderStats(){
  let sigs=filtered;
  let total=sigs.length;
  let targets=sigs.filter(s=>s.outcome==='target_hit').length;
  let stops=sigs.filter(s=>s.outcome==='stop_hit').length;
  let resolved=targets+stops;
  let wr=resolved>0?Math.round(targets/resolved*100):0;
  let pending=sigs.filter(s=>!s.outcome||s.outcome==='pending').length;
  let avgScore=total>0?Math.round(sigs.reduce((a,s)=>a+(s.grade_score||s.score||0),0)/total):0;
  let avgRR=total>0?(sigs.reduce((a,s)=>a+(s.risk_reward||0),0)/total).toFixed(2):'0';
  let totalPnL=sigs.reduce((a,s)=>{let p=calcPnL(s);return a+(p||0);},0).toFixed(2);
  let pnlColor=parseFloat(totalPnL)>=0?'var(--green)':'var(--red)';

  document.getElementById('statsGrid').innerHTML=`
    <div class="stat-card"><h4>Total Signals</h4><div class="val">${total}</div></div>
    <div class="stat-card sc-green"><h4>Targets Hit</h4><div class="val" style="color:var(--green)">${targets}</div></div>
    <div class="stat-card sc-red"><h4>Stops Hit</h4><div class="val" style="color:var(--red)">${stops}</div></div>
    <div class="stat-card sc-blue"><h4>Win Rate</h4><div class="val" style="color:var(--blue)">${wr}%</div></div>
    <div class="stat-card sc-gold"><h4>Pending</h4><div class="val" style="color:var(--gold)">${pending}</div></div>
    <div class="stat-card sc-purple"><h4>Avg Score</h4><div class="val" style="color:var(--purple)">${avgScore}</div></div>
    <div class="stat-card sc-orange"><h4>Avg R:R</h4><div class="val" style="color:var(--orange)">${avgRR}</div></div>
    <div class="stat-card ${parseFloat(totalPnL)>=0?'sc-green':'sc-red'}"><h4>Total P&L</h4><div class="val" style="color:${pnlColor}">${totalPnL}%</div></div>
  `;
}

function renderGrades(){
  let grades=['A+','A','B+'];
  let html='';
  grades.forEach(g=>{
    let gs=allSignals.filter(s=>(s.grade||s.signal_grade||'')===g);
    let t=gs.length;
    let tgt=gs.filter(s=>s.outcome==='target_hit').length;
    let stp=gs.filter(s=>s.outcome==='stop_hit').length;
    let res=tgt+stp;
    let wr=res>0?Math.round(tgt/res*100):0;
    let avgSc=t>0?Math.round(gs.reduce((a,s)=>a+(s.grade_score||s.score||0),0)/t):0;
    let avgConf=t>0?Math.round(gs.reduce((a,s)=>{let p=s.probability?s.probability*100:parseFloat(s.confidence)||0;return a+p;},0)/t):0;
    let pnl=gs.reduce((a,s)=>{let p=calcPnL(s);return a+(p||0);},0).toFixed(2);
    let pC=parseFloat(pnl)>=0?'var(--green)':'var(--red)';

    html+=`<div class="grade-card"><h3>${g} Signals (${t})</h3>
      <div class="gd-row"><span>Win Rate</span><span style="font-weight:600">${wr}%</span></div>
      <div class="gd-row"><span>Targets Hit</span><span style="color:var(--green)">${tgt}</span></div>
      <div class="gd-row"><span>Stops Hit</span><span style="color:var(--red)">${stp}</span></div>
      <div class="gd-row"><span>Avg Score</span><span>${avgSc}</span></div>
      <div class="gd-row"><span>Avg Confidence</span><span>${avgConf}%</span></div>
      <div class="gd-row"><span>Total P&L</span><span style="color:${pC};font-weight:600">${pnl}%</span></div>
    </div>`;
  });
  document.getElementById('gradeGrid').innerHTML=html;
}

function renderTable(){
  let sl=filtered.slice((currentPage-1)*PER_PAGE,currentPage*PER_PAGE);
  let arrow=function(col){return sortCol===col?(sortDir==='asc'?' ‚ñ≤':' ‚ñº'):'';};

  let h=`<table><thead><tr>
    <th onclick="sortBy('scan_date')">Date${arrow('scan_date')}</th>
    <th onclick="sortBy('symbol')">Symbol${arrow('symbol')}</th>
    <th onclick="sortBy('direction')">Dir${arrow('direction')}</th>
    <th onclick="sortBy('grade')">Grade${arrow('grade')}</th>
    <th onclick="sortBy('grade_score')">Score${arrow('grade_score')}</th>
    <th>Models</th>
    <th onclick="sortBy('entry')">Entry${arrow('entry')}</th>
    <th onclick="sortBy('sl')">SL${arrow('sl')}</th>
    <th onclick="sortBy('target')">Target${arrow('target')}</th>
    <th onclick="sortBy('risk_reward')">R:R${arrow('risk_reward')}</th>
    <th>Conf</th>
    <th>Trend</th>
    <th>Outcome</th>
    <th class="track-col">Track Status</th>
    <th class="track-col">Live P&L</th>
    <th>Exit ‚Çπ</th>
    <th>P&L%</th>
  </tr></thead><tbody>`;

  sl.forEach(s=>{
    let dir=(s.direction||'').toUpperCase();
    let isLong=dir.includes('LONG')||dir.includes('BUY');
    let dCls=isLong?'color:#27ae60':'color:#e74c3c';
    let dTxt=isLong?'LONG':'SHORT';
    let g=s.grade||s.signal_grade||'';
    let gCls=g==='A+'?'color:#27ae60;font-weight:700':g==='A'?'color:#2980b9;font-weight:700':'color:#d35400;font-weight:600';
    let sc=s.grade_score||s.score||0;
    let ent=s.entry||0;
    let slv=s.sl||s.stop_loss||0;
    let tgt=s.target||0;
    let rr=s.risk_reward||0;
    let conf=s.probability?Math.round(s.probability*100)+'%':(s.confidence||'‚Äî');
    let trend=s.trend||'‚Äî';
    let oc=s.outcome||'pending';
    let ep=s.exit_price||'';
    let pnl=calcPnL(s);
    let pnlCls=pnl>0?'color:#27ae60':pnl<0?'color:#e74c3c':'color:#7f8c8d';
    let pnlTxt=pnl!==null?pnl.toFixed(2)+'%':'‚Äî';
    let fno=s.is_fno?'<span style="font-size:0.6rem;background:rgba(91,143,168,0.2);padding:1px 4px;border-radius:3px;margin-left:4px">FnO</span>':'';

    // Track status
    let trackStatus='';
    let trackClass='';
    let ts=s.track_status||'';
    switch(ts){
      case 'open':trackClass='ts-open';trackStatus='üîµ Open';break;
      case 'target_hit':trackClass='ts-target';trackStatus='‚úÖ Target';break;
      case 'stop_hit':trackClass='ts-stop';trackStatus='‚ùå SL Hit';break;
      case 'expired':trackClass='ts-expired';trackStatus='‚è∞ Expired';break;
      case 'error':trackClass='ts-error';trackStatus='‚ö†Ô∏è Error';break;
      default:trackClass='ts-pending';trackStatus='‚è≥ Not Tracked';
    }

    // Live P&L
    let livePnl='';
    if(ts==='open' && s.live_pnl_pct!==undefined){
      let lCls=s.live_pnl_pct>0?'favor':s.live_pnl_pct<0?'against':'neutral';
      let arrow2=s.live_pnl_pct>0?'‚ñ≤':s.live_pnl_pct<0?'‚ñº':'‚Äî';
      livePnl=`<span class="pnl-live ${lCls}">${arrow2} ‚Çπ${s.live_pnl_price||0} (${s.live_pnl_pct}%)</span>`;
      if(s.sl_distance!==undefined){
        livePnl+=`<div class="track-details">SL: ‚Çπ${s.sl_distance} away</div>`;
        livePnl+=`<div class="track-details">Tgt: ‚Çπ${s.target_distance} away</div>`;
      }
    } else if(ts==='target_hit'){
      livePnl=`<span class="pnl-live favor">‚úÖ Target Hit</span>`;
    } else if(ts==='stop_hit'){
      livePnl=`<span class="pnl-live against">‚ùå SL Hit</span>`;
    } else if(ts==='expired'){
      livePnl=`<span class="pnl-live neutral">Expired</span>`;
    } else {
      livePnl='<span class="pnl-live neutral">‚Äî</span>';
    }

    // Extra track info
    let trackExtra='';
    if(s.last_tracked) trackExtra+=`<div class="track-details">Checked: ${s.last_tracked}</div>`;
    if(s.trigger_date) trackExtra+=`<div class="track-details">Triggered: ${s.trigger_date}</div>`;
    if(s.days_pending>0 && (!ts||ts==='pending')) trackExtra+=`<div class="track-details">Pending: ${s.days_pending} day(s)</div>`;

    h+=`<tr>
      <td>${s.scan_date||'‚Äî'}</td>
      <td>${s.symbol||'‚Äî'}${fno}</td>
      <td style="${dCls}">${dTxt}</td>
      <td style="${gCls}">${g}</td>
      <td>${sc}</td>
      <td>${modelDots(s)}</td>
      <td style="color:#5b8fa8">‚Çπ${Number(ent).toFixed(2)}</td>
      <td style="color:#e74c3c">‚Çπ${Number(slv).toFixed(2)}</td>
      <td style="color:#27ae60">‚Çπ${Number(tgt).toFixed(2)}</td>
      <td>${Number(rr).toFixed(2)}</td>
      <td>${conf}</td>
      <td>${trend}</td>
      <td><select onchange="updateOutcome('${s._id}',this.value)" style="font-size:0.72rem;padding:2px;border-radius:4px;border:1px solid #ddd">
        <option value="pending" ${oc==='pending'?'selected':''}>‚è≥ Pending</option>
        <option value="target_hit" ${oc==='target_hit'?'selected':''}>‚úÖ Target Hit</option>
        <option value="stop_hit" ${oc==='stop_hit'?'selected':''}>‚ùå Stop Hit</option>
        <option value="expired" ${oc==='expired'?'selected':''}>‚è∞ Expired</option>
      </select></td>
      <td class="track-col"><span class="track-status ${trackClass}">${trackStatus}</span>${trackExtra}</td>
      <td class="track-col">${livePnl}</td>
      <td><input type="number" value="${ep}" onchange="updateExit('${s._id}',this.value)" style="width:70px;font-size:0.72rem;padding:2px;border:1px solid #ddd;border-radius:4px" placeholder="Exit ‚Çπ"></td>
      <td style="${pnlCls};font-weight:600">${pnlTxt}</td>
    </tr>`;
  });

  h+='</tbody></table>';

  // Pagination
  let totalPages=Math.ceil(filtered.length/PER_PAGE);
  if(totalPages>1){
    h+='<div class="pagination">';
    h+=`<button onclick="goPage(1)" ${currentPage===1?'disabled':''}>¬´</button>`;
    h+=`<button onclick="goPage(${currentPage-1})" ${currentPage===1?'disabled':''}>‚Äπ</button>`;
    let startP=Math.max(1,currentPage-2);
    let endP=Math.min(totalPages,startP+4);
    if(endP-startP<4) startP=Math.max(1,endP-4);
    for(let p=startP;p<=endP;p++){
      h+=`<button onclick="goPage(${p})" ${p===currentPage?'style="background:#5b8fa8;color:#fff"':''}>${p}</button>`;
    }
    h+=`<button onclick="goPage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>‚Ä∫</button>`;
    h+=`<button onclick="goPage(${totalPages})" ${currentPage===totalPages?'disabled':''}>¬ª</button>`;
    h+='</div>';
  }

  document.getElementById('signalLog').innerHTML=h;
  document.querySelector('.signal-log h3 span').textContent=filtered.length;
}

function goPage(p){currentPage=p;renderTable();}

function render(){
  renderStats();
  renderGrades();
  renderTable();
}

function exportCSV(){
  let csv='Date,Symbol,FnO,Direction,Grade,Score,Entry,SL,Target,RR,Confidence,Trend,Outcome,TrackStatus,LivePnL,ExitPrice,PnL%\n';
  filtered.forEach(s=>{
    let dir=(s.direction||'').toUpperCase();
    let isLong=dir.includes('LONG')||dir.includes('BUY');
    let pnl=calcPnL(s);
    csv+=`${s.scan_date||''},${s.symbol||''},${s.is_fno?'Yes':'No'},${isLong?'LONG':'SHORT'},${s.grade||''},${s.grade_score||s.score||0},${s.entry||0},${s.sl||s.stop_loss||0},${s.target||0},${s.risk_reward||0},${s.probability?Math.round(s.probability*100)+'%':(s.confidence||'')},${s.trend||''},${s.outcome||'pending'},${s.track_status||'not_tracked'},${s.live_pnl_pct||''},${s.exit_price||''},${pnl!==null?pnl:''}\n`;
  });
  let blob=new Blob([csv],{type:'text/csv'});
  let url=URL.createObjectURL(blob);
  let a=document.createElement('a');
  a.href=url;
  a.download=`signal_history_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function clearAll(){
  if(confirm('Are you sure? This will delete ALL signal history permanently.')){
    allSignals=[];
    localStorage.removeItem('signalHistory');
    applyFilters();
  }
}

// ‚îÅ‚îÅ‚îÅ RESCAN TRADES TRACKING ‚îÅ‚îÅ‚îÅ

function getApiUrl(){
  return (localStorage.getItem('ptScannerApiUrl')||'https://peak-trough-scanner.onrender.com').replace(/\/+$/,'');
}

async function rescanTrades(){
  const btn=document.getElementById('rescanBtn');
  const statusBox=document.getElementById('rescanStatus');
  const bar=document.getElementById('rsBar');
  const text=document.getElementById('rsText');
  const result=document.getElementById('rsResult');

  // Get trackable signals: pending + open (not expired/target_hit/stop_hit)
  let trackable=allSignals.filter(s=>{
    let oc=s.outcome||'pending';
    let ts=s.track_status||'';
    return (oc==='pending' && ts!=='expired' && ts!=='target_hit' && ts!=='stop_hit') || ts==='open';
  });

  // Remove duplicates by _id
  let seen=new Set();
  let toTrack=[];
  trackable.forEach(s=>{
    if(!seen.has(s._id)){seen.add(s._id);toTrack.push(s);}
  });

  if(toTrack.length===0){
    alert('No pending or open trades to rescan.\n\nAll trades are either expired, target hit, or stop hit.');
    return;
  }

  // Show status
  btn.disabled=true;
  btn.innerHTML='‚è≥ Rescanning...';
  statusBox.classList.add('active');
  bar.style.width='0%';
  text.textContent=`Found ${toTrack.length} trades to track...`;
  result.innerHTML='';

  let apiUrl=getApiUrl();

  // Wake up server
  text.textContent='Waking up server (may take 30s if sleeping)...';
  bar.style.width='5%';

  try{
    let controller=new AbortController();
    let timeoutId=setTimeout(()=>controller.abort(),30000);
    await fetch(`${apiUrl}/api/health`,{signal:controller.signal});
    clearTimeout(timeoutId);
  }catch(e){
    text.textContent='Server waking up, continuing...';
  }

  bar.style.width='10%';
  text.textContent='Server ready. Sending signals for tracking...';

  // Batch (max 20 per request)
  const BATCH_SIZE=20;
  let batches=[];
  for(let i=0;i<toTrack.length;i+=BATCH_SIZE){
    batches.push(toTrack.slice(i,i+BATCH_SIZE));
  }

  let stats={triggered:0,expired:0,pending:0,targetHit:0,stopHit:0,open:0,errors:0};
  let processedCount=0;

  for(let bIdx=0;bIdx<batches.length;bIdx++){
    let batch=batches[bIdx];

    let payload=batch.map(s=>({
      _id:s._id,
      symbol:s.symbol||'',
      yahoo_ticker:s.yahoo_ticker||(s.symbol?s.symbol+'.NS':''),
      entry:s.entry||0,
      sl:s.sl||s.stop_loss||0,
      target:s.target||0,
      direction:s.direction||'',
      signal_date:s.scan_date||'',
      days_pending:s.days_pending||0
    }));

    text.textContent=`Tracking batch ${bIdx+1}/${batches.length} (${batch.length} signals)...`;

    try{
      let controller2=new AbortController();
      let timeoutId2=setTimeout(()=>controller2.abort(),120000);
      let resp=await fetch(`${apiUrl}/api/track`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({signals:payload}),
        signal:controller2.signal
      });
      clearTimeout(timeoutId2);

      if(!resp.ok) throw new Error(`Server error: ${resp.status}`);

      let data=await resp.json();

      if(data.results && Array.isArray(data.results)){
        data.results.forEach(r=>{
          let idx=allSignals.findIndex(s=>s._id===r._id);
          if(idx===-1) return;

          let sig=allSignals[idx];
          sig.track_status=r.status||'pending';
          sig.last_tracked=r.last_checked||new Date().toISOString().slice(0,16).replace('T',' ');
          sig.days_pending=r.days_pending||sig.days_pending||0;

          if(r.entry_triggered) sig.trigger_date=r.trigger_date||'';

          if(r.status==='open'){
            sig.live_pnl_price=r.pnl_price||0;
            sig.live_pnl_pct=r.pnl_pct||0;
            sig.current_close=r.current_close||0;
            sig.sl_distance=r.sl_distance||0;
            sig.target_distance=r.target_distance||0;
            stats.open++;
          } else if(r.status==='target_hit'){
            sig.outcome='target_hit';
            sig.exit_price=r.exit_price||sig.target;
            sig.pnl=calcPnL(sig);
            stats.targetHit++;
          } else if(r.status==='stop_hit'){
            sig.outcome='stop_hit';
            sig.exit_price=r.exit_price||(sig.sl||sig.stop_loss);
            sig.pnl=calcPnL(sig);
            stats.stopHit++;
          } else if(r.status==='expired'){
            sig.outcome='expired';
            sig.track_status='expired';
            stats.expired++;
          } else if(r.status==='error'){
            sig.track_status='error';
            stats.errors++;
          } else {
            stats.pending++;
          }

          allSignals[idx]=sig;
        });
      }
    }catch(e){
      console.error(`Batch ${bIdx+1} error:`,e);
      stats.errors+=batch.length;
      text.textContent=`Batch ${bIdx+1} failed: ${e.message}. Continuing...`;
    }

    processedCount+=batch.length;
    let pct=10+Math.round((processedCount/toTrack.length)*85);
    bar.style.width=pct+'%';
  }

  // Save
  localStorage.setItem('signalHistory',JSON.stringify(allSignals));
  bar.style.width='100%';
  text.textContent='‚úÖ Rescan complete!';

  result.innerHTML=`
    <div><span class="open-trade">üîµ Open trades: ${stats.open}</span></div>
    <div><span class="triggered">‚úÖ Targets hit: ${stats.targetHit}</span></div>
    <div><span class="expired">‚ùå Stops hit: ${stats.stopHit}</span></div>
    <div><span class="still-pending">‚è≥ Still pending: ${stats.pending}</span></div>
    <div><span class="expired">‚è∞ Expired: ${stats.expired}</span></div>
    ${stats.errors>0?`<div><span class="expired">‚ö†Ô∏è Errors: ${stats.errors}</span></div>`:''}
  `;

  // Re-render
  applyFilters();

  // Reset button
  btn.disabled=false;
  btn.innerHTML='üîÑ Rescan Trades';

  // Auto-hide after 10s
  setTimeout(()=>{statusBox.classList.remove('active');},10000);
}

// ‚îÅ‚îÅ‚îÅ INIT ‚îÅ‚îÅ‚îÅ
applyFilters();
</script>
</body>
</html>
